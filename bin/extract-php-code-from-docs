#!/usr/bin/env php
<?php

use League\CommonMark\Environment\Environment;
use League\CommonMark\Extension\CommonMark\CommonMarkCoreExtension;
use League\CommonMark\Extension\CommonMark\Node\Block\FencedCode;
use League\CommonMark\Extension\GithubFlavoredMarkdownExtension;
use League\CommonMark\Node\Query;
use League\CommonMark\Parser\MarkdownParser;

require __DIR__ . '/../vendor/autoload.php';


$environment = new Environment([]);
$environment->addExtension(new CommonMarkCoreExtension());
$environment->addExtension(new GithubFlavoredMarkdownExtension());

$parser = new MarkdownParser($environment);

$path = __DIR__ . '/../docs/pages/subscription.md';
$targetDir = __DIR__ . '/../docs_php';

if (file_exists($targetDir)) {
    exec('rm -rf ' . $targetDir);
}

mkdir($targetDir);

$finder = new Symfony\Component\Finder\Finder();
$finder->files()->in(__DIR__ . '/../docs/pages')->name('*.md');

foreach ($finder as $file) {
    $fileName = pathinfo($file->getBasename(), PATHINFO_FILENAME);

    $content = file_get_contents($file->getPathname());
    $document = $parser->parse($content);

    $result = (new Query())
        ->where(Query::type(FencedCode::class))
        ->findAll($document);

    /**
     * @var FencedCode $node
     */
    foreach ($result as $node) {
        if ($node->getInfo() !== 'php') {
            continue;
        }

        $source = sprintf('%s:%s', $file->getRealPath(), $node->getStartLine());

        $code = "<?php // " . $source . " \n\n" . $node->getLiteral() . "\n";

        $targetPath = $targetDir . '/' . $fileName . '_' . $node->getStartLine() . '.php';
        file_put_contents($targetPath, $code);

        $node->setLiteral($source);
    }
}
